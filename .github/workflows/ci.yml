name: CI/CD Pipeline

# ============================================================================
# QUAND ?
# ============================================================================
# Ce workflow s'ex√©cute √† chaque push et pull request sur main
on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

# ============================================================================
# VARIABLES GLOBALES
# ============================================================================
env:
    NODE_VERSION: "20.x"
    NPM_VERSION: "10.x"

# ============================================================================
# JOBS (T√¢ches parall√®les)
# ============================================================================
jobs:
    # ==========================================================================
    # JOB 1 : CODE QUALITY - ESLint
    # ==========================================================================
    lint:
        name: üîç ESLint Validation
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            # T√©l√©charger le code du repository
            - name: Checkout code
              uses: actions/checkout@v4

            # Installer Node.js et npm
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            # Installer les d√©pendances
            - name: Install dependencies
              run: npm ci

            # Lancer ESLint
            - name: Run ESLint
              run: npm run lint
              continue-on-error: false

    # ==========================================================================
    # JOB 2 : TESTS - Vitest
    # ==========================================================================
    test:
        name: üß™ Unit Tests (Vitest)
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            # Lancer les tests une fois
            - name: Run tests
              run: npm run test:run

            # Upload les r√©sultats des tests (optionnel, pour GitHub UI)
            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: coverage/
                  retention-days: 7

    # ==========================================================================
    # JOB 3 : BUILD - Production Build
    # ==========================================================================
    build:
        name: üèóÔ∏è Production Build
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [lint, test]
        # Ne s'ex√©cute que si lint et test passent

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            # V√©rification TypeScript stricte
            - name: TypeScript type check
              run: npx tsc --noEmit

            # Build production
            - name: Build for production
              run: npm run build

            # Upload l'artifact du build (pour le d√©ploiement)
            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: dist
                  path: dist/
                  retention-days: 5

    # ==========================================================================
    # JOB 4 : DEPLOY - Vercel (Seulement sur main)
    # ==========================================================================
    deploy:
        name: üöÄ Deploy to Vercel
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: build
        # Ne s'ex√©cute que sur main (pas sur les PRs)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build for production
              run: npm run build

            # D√©ployer sur Vercel
            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: "--prod"

            - name: Print deployment URL
              run: echo "‚úÖ Deployment successful!"
# ============================================================================
# R√âSUM√â DE L'EX√âCUTION
# ============================================================================
# Ce workflow :
#
# 1. Sur CHAQUE push/PR sur main :
#    - Valide le code (ESLint)
#    - Lance tous les tests (Vitest)
#
# 2. Si lint + tests passent, alors :
#    - Build production (TypeScript + Vite)
#    - Upload du build pour cache
#
# 3. Si c'est un PUSH sur main (pas PR), alors :
#    - D√©ploie sur Vercel (production)
#
# Temps total : ~5-10 minutes
#
# ============================================================================
# SECRETS REQUIS (√† configurer dans GitHub)
# ============================================================================
# Settings ‚Üí Secrets and variables ‚Üí Actions
#
# - VERCEL_TOKEN       : Token d'acc√®s Vercel
# - VERCEL_ORG_ID      : ID organisation Vercel
# - VERCEL_PROJECT_ID  : ID projet Vercel
#
# Comment les obtenir :
# 1. Aller sur https://vercel.com/account/tokens
# 2. Cr√©er un token "CI/CD"
# 3. Copier le token ‚Üí VERCEL_TOKEN
# 4. R√©cup√©rer ORG_ID et PROJECT_ID dans les settings du projet Vercel
#
# ============================================================================
